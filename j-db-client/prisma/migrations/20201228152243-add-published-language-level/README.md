# Migration `20201228152243-add-published-language-level`

This migration has been generated by Robin MacPherson at 12/28/2020, 7:22:43 AM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
ALTER TABLE "Post" ADD COLUMN     "publishedLanguageLevel" "LanguageLevel" NOT NULL DEFAULT E'BEGINNER'
```

## Data Migration

```sql
-- Bring users' publishedLanguageLevels up-to-date with their current LanguageLevel
UPDATE "Post"
SET "publishedLanguageLevel"=subquery.level
FROM (SELECT "Post"."id" AS "postId", "authorId", "LanguageRelation"."level"
FROM "Post"
JOIN "LanguageRelation" ON "userId" = "authorId"
	AND "LanguageRelation"."languageId" = "Post"."languageId") AS subquery
WHERE "Post".id = subquery."postId"
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20201223171239-replace-location-model..20201228152243-add-published-language-level
--- datamodel.dml
+++ datamodel.dml
@@ -1,7 +1,7 @@
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 generator prisma_client {
   provider = "prisma-client-js"
@@ -116,8 +116,9 @@
   readTime                 Int                       @default(1)
   likes                    PostLike[]
   language                 Language                  @relation(fields: [languageId], references: [id])
   languageId               Int
+  publishedLanguageLevel   LanguageLevel             @default(BEGINNER)
   longitude                Float?
   latitude                 Float?
   threads                  Thread[]
   postTopics               PostTopic[]
```


